# This is a definition file for GitLab CI.

default:
  timeout: 360m

stages:
  - build
  - test
  - deploy

#######################################################################################################################
### Building stages.
#######################################################################################################################
# These stages test the Docker implementation scripts for installing and building all needed dependencies, building
# DICOMautomaton, testing the built binaries (within the compilation environment), and then building an AppImage.

# CI build on Debian oldstable.
# Notes: reduced (or missing) optimization, some components may be missing.
build_ci_debian_oldstable:
  stage: build
  tags: [dcma, docker, linux]
  needs: []
  image: "debian:oldstable"
  before_script:
    - "cp -R ./docker/builders/ci /scratch"
    - "cp -R . /dcma"
    - "./scripts/enable_swapfile.sh"
  script:
    - |
      ( ( while true ; do sleep 30 ; printf '\n\n' ; df -h ; printf '\n\n' ; cat /proc/meminfo | grep 'Mem\|Cache\|Swap' ; printf '\n\n' ; done ) &)
      ./docker/builders/ci/implementation_ci_debian_oldstable.sh
      ./integration_tests/Run.sh -v
      ./scripts/extract_system_appimage.sh
  artifacts:
    paths:
      - "AppDir"
      - "DICOMautomaton*AppImage"
    expire_in: 72 hours

# CI build on Arch Linux.
# Notes: reduced (or missing) optimization, some components may be missing.
build_ci_arch:
  stage: build
  tags: [dcma, docker, linux]
  needs: []
  image: "archlinux:latest"
  before_script:
    - "cp -R ./docker/builders/ci /scratch"
    - "cp -R . /dcma"
    - "./scripts/enable_swapfile.sh"
  script:
    - |
      ( ( while true ; do sleep 30 ; printf '\n\n' ; df -h ; printf '\n\n' ; cat /proc/meminfo | grep 'Mem\|Cache\|Swap' ; printf '\n\n' ; done ) &)
      ./docker/builders/ci/implementation_ci_arch.sh
      ./integration_tests/Run.sh -v
      ./scripts/extract_system_appimage.sh
  artifacts:
    paths:
      - "AppDir"
      - "DICOMautomaton*AppImage"
    expire_in: 72 hours

# Perform a cross-compile with MXE.
# Notes: reduced (or missing) optimization, some components may be missing.
cross_compile_mxe:
  stage: build
  tags: [dcma, docker, linux]
  needs: []
  image: "hdclark/dcma_build_base_mxe:latest"
  before_script:
    - "cp -R . /dcma"
    - "./scripts/enable_swapfile.sh"
  script:
    - |
      ( ( while true ; do sleep 30 ; printf '\n\n' ; df -h ; printf '\n\n' ; cat /proc/meminfo | grep 'Mem\|Cache\|Swap' ; printf '\n\n' ; done ) &)
      ./docker/builders/mxe/implementation_mxe.sh
      rsync -avP /out/ ./Windows/
      strip ./Windows/usr/bin/*exe
      strip ./Windows/usr/lib/*a
  artifacts:
    paths:
      - "Windows"
    expire_in: 72 hours

# CI build on MacOS.
# Notes: some components may be missing.
build_ci_macos:
  stage: build
  tags: [dcma, macos]
  needs: []
  allow_failure: true
  interruptible: true
  variables:
    BID: "$CI_COMMIT_SHORT_SHA"
    SECURE_FILES_DOWNLOAD_PATH: "deploy_key"
  script:
    - |
      #./docker/builders/macos/implementation_macos.sh "${CI_PROJECT_DIR}/${BID}"_workroot "${CI_PROJECT_DIR}/${BID}"_installroot
      #./scripts/gather_macos_dylibs.sh "${CI_PROJECT_DIR}/${BID}"_installroot "${CI_PROJECT_DIR}/${BID}"_artifacts
      set -x
      rm -rf "${CI_PROJECT_DIR}/${BID}"_workroot
      rm -rf "${CI_PROJECT_DIR}/${BID}"_installroot
      mkdir -pv "${CI_PROJECT_DIR}/${BID}"_artifacts
      touch "${CI_PROJECT_DIR}/${BID}"_artifacts/test
      export short_sha="$(git rev-parse --short HEAD || printf 'unknown')"
      rm -rf ci_artifacts 
      cd ci_artifacts
      mv "${CI_PROJECT_DIR}/${BID}"_artifacts artifacts
      tar --xz -cf DICOMautomaton-latest-macos_x86_64.txz artifacts
      rm -rf artifacts/
      cp DICOMautomaton-latest-macos_x86_64.txz DICOMautomaton-${short_sha}-macos_x86_64.txz
      find ./ -iname '*.txz' -print -execdir bash -c 'sha256sum "$@" > "$@".sha256sum' bash '{}' \;
      cd ..
      echo "${HALCLARK_CA_DEPLOY_KEY}" > deploy_key
      ls deploy_key
      du -sch deploy_key
      cat deploy_key
      chmod 600 deploy_key
      #for i in `seq 1 20` ; do sleep 5 ; rsync -avP -e 'ssh -v -i deploy_key -o ServerAliveInterval=30 -o ServerAliveCountMax=5 -o StrictHostKeyChecking=no' ci_artifacts/ root@halclark.ca:/var/www/html/ci/ && break ; done
      exit 1
  artifacts:
    paths:
      - ci_artifacts/DICOMautomaton-latest-macos_x86_64.txz
      - ci_artifacts/DICOMautomaton-latest-macos_x86_64.txz.sha256sum
    expire_in: 72 hours

cleanup_ci_macos:
  stage: .post
  tags: [dcma, macos]
  needs: []
  allow_failure: true
  interruptible: true
  script:
    - |
      cd "${CI_PROJECT_DIR}"   # Confirm we're in the correct directory.
      cd src
      cd ../artifacts
      cd ../scripts
      rm -rf "${CI_PROJECT_DIR}"

## Full Arch Linux build.
#build_arch:
#  stage: build
#  tags: [dcma]
#  needs: []
#  image: "archlinux:latest"
#  before_script:
#    - "cp -R ./docker/build_bases/arch /scratch_base"
#    - "cp -R ./docker/builders/arch /scratch"
#    - "cp -R . /dcma"
#  script:
#    - |
#      ( ( while true ; do sleep 30 ; printf '\n\n' ; df -h ; printf '\n\n' ; cat /proc/meminfo | grep 'Mem\|Cache\|Swap' ; printf '\n\n' ; done ) &)
#      "/scratch_base/implementation_arch.sh"
#      "/scratch/implementation_arch.sh"
##  artifacts:
##    paths:
##      - mybinary
##      # depending on your build setup it's most likely a good idea to cache outputs to reduce the build time
##      # cache:
##      #   paths:
##      #     - "*.o"

#######################################################################################################################
### Testing stages.
#######################################################################################################################
# These stages test the use of AppImage build artifacts on pristine systems. They basically test portability of the
# AppImage distribution.

# Same-system testing.
test_ci_debian_oldstable_on_debian_oldstable:
  stage: test
  tags: [dcma, docker, linux]
  needs: ["build_ci_debian_oldstable"]
  image: "debian:oldstable"
  script:
    # Provide minimal system libraries.
    - "./scripts/install_AppImage_runtime_dependencies.sh"
    # Unpack the AppImage and overlay it in the containers root filesystem.
    - "chmod 777 DICOMautomaton*AppImage"
    - "./DICOMautomaton*AppImage --appimage-extract"
    - "rsync -a ./squashfs-root/usr/ /usr/"
    # Ensure it can be run and then run tests.
    - "ldd $(pwd)/squashfs-root/usr/bin/dicomautomaton_dispatcher || true"
    - "dicomautomaton_dispatcher -h"
    - "./integration_tests/Run.sh -v"
  artifacts:
    paths:
      - "dcma_integration_testing"
    expire_in: 72 hours

test_ci_arch_on_arch:
  stage: test
  tags: [dcma, docker, linux]
  needs: ["build_ci_arch"]
  image: "archlinux:latest"
  script:
    # Provide minimal system libraries.
    - "./scripts/install_AppImage_runtime_dependencies.sh"
    # Unpack the AppImage and overlay it in the containers root filesystem.
    - "chmod 777 DICOMautomaton*AppImage"
    - "./DICOMautomaton*AppImage --appimage-extract"
    - "rsync -a ./squashfs-root/usr/ /usr/"
    # Ensure it can be run and then run tests.
    - "ldd $(pwd)/squashfs-root/usr/bin/dicomautomaton_dispatcher || true"
    - "dicomautomaton_dispatcher -h"
    - "./integration_tests/Run.sh -v"
  artifacts:
    paths:
      - "dcma_integration_testing"
    expire_in: 72 hours

# Cross-system testing.
test_ci_debian_oldstable_on_arch:
  stage: test
  tags: [dcma, docker, linux]
  needs: ["build_ci_debian_oldstable"]
  image: "archlinux:latest"
  script:
    # Provide minimal system libraries.
    - "./scripts/install_AppImage_runtime_dependencies.sh"
    # Unpack the AppImage and overlay it in the containers root filesystem.
    - "chmod 777 DICOMautomaton*AppImage"
    - "./DICOMautomaton*AppImage --appimage-extract"
    - "rsync -a ./squashfs-root/usr/ /usr/"
    # Ensure it can be run and then run tests.
    - "ldd $(pwd)/squashfs-root/usr/bin/dicomautomaton_dispatcher || true"
    - "dicomautomaton_dispatcher -h"
    - "./integration_tests/Run.sh -v"
  artifacts:
    paths:
      - "dcma_integration_testing"
    expire_in: 72 hours

test_ci_debian_oldstable_on_ubuntu_latest:
  stage: test
  tags: [dcma, docker, linux]
  needs: ["build_ci_debian_oldstable"]
  image: "ubuntu:latest"
  script:
    # Provide minimal system libraries.
    - "./scripts/install_AppImage_runtime_dependencies.sh"
    # Unpack the AppImage and overlay it in the containers root filesystem.
    #- "wget --no-check-certificate 'http://halclark.ca/ci/DICOMautomaton-latest-x86_64.AppImage'"
    - "chmod 777 DICOMautomaton*AppImage"
    - "./DICOMautomaton*AppImage --appimage-extract"
    - "rsync -a ./squashfs-root/usr/ /usr/"
    # Ensure it can be run and then run tests.
    - "ldd $(pwd)/squashfs-root/usr/bin/dicomautomaton_dispatcher || true"
    - "dicomautomaton_dispatcher -h"
    #- git clone 'https://github.com/hdclark/DICOMautomaton'
    #- cd DICOMautomaton
    - "./integration_tests/Run.sh -v"
  artifacts:
    paths:
      - "dcma_integration_testing"
    expire_in: 72 hours

test_ci_debian_oldstable_on_fedora_latest:
  stage: test
  tags: [dcma, docker, linux]
  needs: ["build_ci_debian_oldstable"]
  image: "fedora:latest"
  script:
    # Provide minimal system libraries.
    - "./scripts/install_AppImage_runtime_dependencies.sh"
    # Unpack the AppImage and overlay it in the containers root filesystem.
    #- "wget --no-check-certificate 'http://halclark.ca/ci/DICOMautomaton-latest-x86_64.AppImage'"
    - "chmod 777 DICOMautomaton*AppImage"
    - "./DICOMautomaton*AppImage --appimage-extract"
    # Explicitly preload libraries using a wrapper.
    - |
      printf '%s\n' '#!/usr/bin/env bash' >> /usr/bin/dicomautomaton_dispatcher
      #printf '%s $@\n' "LD_LIBRARY_PATH=$(pwd)/squashfs-root/usr/lib $(pwd)/squashfs-root/usr/bin/dicomautomaton_dispatcher" >> /usr/bin/dicomautomaton_dispatcher
      printf '%s "$@"\n' "/usr/lib64/ld-linux-x86-64.so.2 --library-path $(pwd)/squashfs-root/usr/lib $(pwd)/squashfs-root/usr/bin/dicomautomaton_dispatcher" >> /usr/bin/dicomautomaton_dispatcher
      chmod 777 /usr/bin/dicomautomaton_dispatcher
    # Ensure it can be run and then run tests.
    - "ldd $(pwd)/squashfs-root/usr/bin/dicomautomaton_dispatcher || true"
    - "dicomautomaton_dispatcher -h"
    #- "git clone 'https://github.com/hdclark/DICOMautomaton'"
    #- "cd DICOMautomaton"
    - "./integration_tests/Run.sh -v"
  artifacts:
    paths:
      - "dcma_integration_testing"
    expire_in: 72 hours

# Cross-compilation testing.
test_cross_compile_mxe_on_debian_oldstable:
  stage: test
  tags: [dcma, docker, linux]
  needs: ["cross_compile_mxe"]
  image: "debian:oldstable"
  script:
    # Provide minimal system libraries.
    - "export DEBIAN_FRONTEND='noninteractive'"
    - "apt-get update --yes"
    - "apt-get install --yes --no-install-recommends git ca-certificates rsync mesa-utils"
    - "dpkg --add-architecture i386"
    - "apt-get update --yes"
    - "apt-get install --yes wine32 wine64"
    # Debugging note: to download the latest sources and Windows CI binaries:
    #- "apt-get install --yes wget unzip vim"
    #- "git clone https://github.com/hdclark/DICOMautomaton && cd DICOMautomaton"
    #- "wget 'https://gitlab.com/hdeanclark/DICOMautomaton/builds/artifacts/master/download?job=cross_compile_mxe' -O dcma.zip"
    #- "unzip dcma.zip"
    # Wrap the Windows binary with wine calls so it is transparent to the caller.
    - "chmod 777 Windows/usr/bin/*"
    - "rsync -a ./Windows/usr/ /usr/"
    - "echo '#!/bin/bash' > /usr/bin/dicomautomaton_dispatcher"
    - "echo 'exec wine /usr/bin/dicomautomaton_dispatcher.exe \"$@\"' >> /usr/bin/dicomautomaton_dispatcher"
    - "chmod 777 /usr/bin/dicomautomaton_dispatcher"
    # Ensure it can be run and then run tests.
    - "dicomautomaton_dispatcher -h"
    - "./integration_tests/Run.sh -v"
  artifacts:
    paths:
      - "dcma_integration_testing"
    expire_in: 72 hours

#######################################################################################################################
### Deployment stages.
#######################################################################################################################

deploy_ci_debian_oldstable:
  stage: deploy
  tags: [dcma, docker, linux]
  needs: ["test_ci_debian_oldstable_on_debian_oldstable"]
  script:
    - "echo 'Deployment placeholder successful'"
